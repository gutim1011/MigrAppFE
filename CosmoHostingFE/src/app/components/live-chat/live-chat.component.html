<!-- Panel de chat -->
<div class="flex h-full">
  <!-- Lista de contactos -->
  <div class="w-1/4 bg-white border-r overflow-y-auto">
    <div class="p-4 border-b">
      <h2 class="text-xl font-bold">Conversaciones</h2>
    </div>
    
    <!-- Lista de usuarios filtrados por rol -->
    <div class="overflow-y-auto">
      @for(user of filteredContacts; track user.id) {
        <div 
          (click)="selectChat(user)" 
          class="flex items-center p-3 border-b hover:bg-gray-100 cursor-pointer"
          [class.bg-blue-50]="currentChat?.id === user.id"
        >
          <div class="flex-shrink-0 mr-3">
            @if(user.imageUrl) {
              <img [src]="user.imageUrl" alt="Avatar" class="w-10 h-10 rounded-full">
            } @else {
              <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
                <span class="text-lg font-bold text-gray-600">
                  {{(user.name || '').charAt(0).toUpperCase()}}
                </span>
              </div>
            }
            <span class="absolute w-3 h-3 rounded-full" 
                  [class.bg-green-500]="user.isOnline" 
                  [class.bg-gray-400]="!user.isOnline"
                  style="margin-left: -10px; margin-top: -10px;"></span>
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex justify-between items-center">
              <p class="text-sm font-medium text-gray-900 truncate">
                {{user.name}} {{user.lastName}}
              </p>
              @if(unreadCounts[user.id]) {
                <span class="px-2 py-1 bg-blue-500 text-white rounded-full text-xs">
                  {{unreadCounts[user.id]}}
                </span>
              }
            </div>
            <p class="text-xs text-gray-500 truncate">
              {{user.isTyping ? 'Escribiendo...' : (user.isOnline ? 'En línea' : 'Desconectado')}}
            </p>
          </div>
        </div>
      }
      
      @if(filteredContacts.length === 0) {
        <div class="p-4 text-center text-gray-500">
          No hay contactos disponibles
        </div>
      }
    </div>
  </div>
  
  <!-- Ventana de chat -->
  @if(currentChat) {
    <div class="flex-1 flex flex-col h-full bg-gray-50">
      <!-- Cabecera del chat -->
      <div class="bg-white p-4 border-b flex items-center">
        <div class="flex-1">
          <h3 class="font-bold leading-normal">
            {{currentChat.name | titlecase}} {{currentChat.lastName | titlecase}}
          </h3>
          <span class="text-sm text-gray-500">
            {{currentChat.isTyping ? 'Escribiendo...' : (currentChat.isOnline ? 'En línea' : 'Desconectado')}}
          </span>
        </div>
      </div>
      
      <!-- Área de mensajes -->
      <div #messageContainer class="flex-1 overflow-y-auto p-4" (scroll)="onScroll($event)">
        @if(isLoading) {
          <div class="flex justify-center p-4">
            <span class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></span>
          </div>
        }
        
        @if(messages.length === 0 && !isLoading) {
          <div class="text-center text-gray-500 my-8">
            No hay mensajes. ¡Comienza la conversación!
          </div>
        }
        
        @for(message of messages; track message.id) {
          <div class="mb-4" [ngClass]="{'flex justify-end': isOwnMessage(message)}">
            <div 
              class="max-w-xs md:max-w-md lg:max-w-lg px-4 py-2 rounded-lg"
              [ngClass]="{'bg-blue-500 text-white': isOwnMessage(message), 'bg-white border': !isOwnMessage(message)}"
            >
              <div class="text-sm">{{message.content}}</div>
              <div 
                class="text-xs mt-1"
                [ngClass]="{'text-blue-200': isOwnMessage(message), 'text-gray-500': !isOwnMessage(message)}"
              >
                {{formatMessageTime(message.createdDate)}}
                @if(isOwnMessage(message)) {
                  <span class="ml-1">
                    {{message.isRead ? '✓✓' : '✓'}}
                  </span>
                }
              </div>
            </div>
          </div>
        }
      </div>
      
      <!-- Área de entrada de texto -->
      <div class="bg-white p-4 border-t">
        <div class="flex">
          <input
            #messageInput
            type="text" 
            [(ngModel)]="messageContent"
            (input)="onTyping()"
            placeholder="Escribe un mensaje..."
            class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300"
          >
          <button 
            (click)="sendMessage()"
            [disabled]="!messageContent.trim()"
            class="ml-2 bg-blue-500 text-white rounded-lg px-4 py-2 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 disabled:opacity-50"
          >
            Enviar
          </button>
        </div>
      </div>
    </div>
  } @else {
    <!-- Seleccionar chat -->
    <div class="flex-1 flex items-center justify-center bg-gray-50">
      <div class="text-center p-8">
        <div class="text-6xl mb-4">💬</div>
        <h3 class="text-xl font-bold mb-2">Selecciona un chat</h3>
        <p class="text-gray-500">Elige un contacto para iniciar una conversación</p>
      </div>
    </div>
  }
</div>